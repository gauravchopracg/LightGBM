name: Solaris CRAN check

on:
  push:
    branches: 
      - solaris_ci

jobs:
  test:
    name: solaris-cran
    timeout-minutes: 60
    runs-on: ubuntu-latest
    container: rocker/r-base
    env:
      SECRETS_WORKFLOW: ${{ secrets.WORKFLOW }}
    steps:
      - name: Install essential software before checkout
        shell: bash
        run: |
          apt-get update
          apt-get install --no-install-recommends -y \
            curl \
            git
      - name: Checkout repository
        uses: actions/checkout@v2.3.4
        with:
          fetch-depth: 5
          submodules: true
      - name: Build package
        shell: bash
        id: build_package
        run: |
          sh build-cran-package.sh || exit -1
          apt-get install --no-install-recommends -y \
              libcurl4-openssl-dev \
              libxml2-dev \
              libssl-dev
          check_succeeded="yes"
          Rscript $GITHUB_WORKSPACE/.ci/run_rhub_solaris_checks.R "$(pwd)/lightgbm_*.tar.gz" "(pwd)/logs.txt" || check_succeeded="no"
          cat "(pwd)/logs.txt"
          if [[ $check_succeeded == "no" ]]; then
              exit -1
          fi
